name: Тестирование

on:
  workflow_call:
    inputs:
      v8_version:
        description: 'Версия 1С:Предприятие'
        type: string
        required: true

      locale:
        type: string
        required: false
        default: ru_RU

      artifact_name:
        type: string
        required: false
        default: build-artifacts
        
      fail_on_failure:
        type: boolean
        required: false
        default: true

      os:
        type: string
        required: true

permissions:
    contents: read
    checks: write
    id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref_name }}-${{ inputs.v8_version }}-${{ inputs.locale }}-${{ github.event.number }}-${{inputs.os}}
  cancel-in-progress: true

jobs:
  execute-tests:
    name: Тестирование
    runs-on: ${{inputs.os}}
    steps:

    - name: Загрузка артифактов
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.artifact_name }}
        path: binary

    - name: Подготовка окружения (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y locales 
        sudo ln -s /usr/lib/x86_64-linux-gnu/libenchant-2.so.2 /usr/lib/libenchant.so.1
        sudo localedef -i ${{ inputs.locale }} -c -f UTF-8 -A /usr/share/locale/locale.alias ${{ inputs.locale }}.UTF-8

        mkdir -p ~/.1cv8/1C/1cv8/conf/
        echo "DisableUnsafeActionProtection=.*" >>~/.1cv8/1C/1cv8/conf/conf.cfg
  
    - name: Установка xvfb и зависимостей (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y xvfb x11-utils net-tools libgstreamer-plugins-base1.0-0 gstreamer1.0-plugins-good gstreamer1.0-plugins-bad gstreamer1.0-plugins-ugly
        sudo ldconfig

    - name: Подготовка окружения (Windows)
      if: runner.os == 'Windows'
      run: |
        mkdir -p "C:\Program Files\1cv8\conf"
        "DisableUnsafeActionProtection=.*" | Out-File -FilePath "C:\Program Files\1cv8\conf\conf.cfg" -Encoding utf8 -Append
  
    - name: Определение "короткой" локали
      id: short_locale
      shell: pwsh
      run: |
        Write-Output "substring=$('${{ inputs.locale }}'.Substring(0, 2))" >> $Env:GITHUB_OUTPUT

    - name: Установка 1С:Предприятие
      uses: 1CDevFlow/onec-setup-action@main
      with:
        type: onec
        onec_version: ${{ inputs.v8_version }}
        cache: ${{runner.os == 'Windows'}}
      env: 
        ONEC_USERNAME: ${{ secrets.ONEC_USERNAME }}
        ONEC_PASSWORD: ${{ secrets.ONEC_PASSWORD }}
      timeout-minutes: 10

    - name: Создание информационной базы
      shell: bash
      run: |
        ibcmd infobase create --db-path=file-db --load=binary/configuration.cf --apply --force
      timeout-minutes: 5

    - name: Загрузка расширения c тестами
      uses: 1CDevFlow/workflows/actions/load-extension@main
      with:
        name: tests
        path: binary/tests.cfe

    - name: Загрузка расширения c дымовыми тестами
      uses: 1CDevFlow/workflows/actions/load-extension@main
      with:
        name: Smoke
        path: binary/smoke.cfe

    - name: Загрузка расширения YAxUnit
      uses: 1CDevFlow/workflows/actions/load-extension@main
      with:
        name: YAXUNIT
        path: binary/yaxunit.cfe

    - name: Создание файла конфигурации тестирования
      uses: DamianReeves/write-file-action@master
      with:
        path: yaxunit-config.json
        contents: |
          {
            "reportFormat": "jUnit",
            "reportPath": "report.xml",
            "closeAfterTests": true,
            "exitCode": "exit-code.txt",
            "logging": {
              "console": true,
              "file": "log.txt"
            }
          }

    - name: Запуск тестирования (Linux)
      if: runner.os == 'Linux'
      run: |
        # Запуск ibsrv в фоне
        ibsrv --db-path=file-db --daemon &
        sleep 5
        
        # Проверка, что сервер запустился
        echo "Проверка состояния ibsrv..."
        ps aux | grep ibsrv || echo "ibsrv не найден в процессах"
        
        # Проверка доступности порта
        netstat -tlnp | grep 8314 || echo "Порт 8314 не прослушивается"
        
        # Запуск тестов через xvfb-run
        echo "Запуск тестов через xvfb-run..."
        xvfb-run -a -s "-screen 0 1024x768x24" 1cv8c /WS "http://localhost:8314" /C"RunUnitTests=yaxunit-config.json" /L ${{ steps.short_locale.outputs.substring }} /VL ${{ inputs.locale }} /DisableStartupDialogs /DisableStartupMessages /DisableUnrecoverableErrorMessage /Out output.log
        
        # Проверка результата выполнения
        echo "Код завершения тестов: $?"
      env:
        LANG: "${{ inputs.locale }}.UTF-8"
        DISPLAY: ":99"
      timeout-minutes: 10

    - name: Запуск тестирования (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Запуск ibsrv в фоне
        Start-Process ibsrv.exe -ArgumentList "--db-path=file-db" -WindowStyle Hidden
        Start-Sleep -Seconds 5
        
        # Проверка, что сервер запустился
        Write-Host "Проверка состояния ibsrv..."
        Get-Process ibsrv -ErrorAction SilentlyContinue | Select-Object ProcessName, Id, CPU
        
        # Запуск тестов
        Write-Host "Запуск тестов..."
        $result = Start-Process -NoNewWindow -PassThru -Wait 1cv8c.exe -ArgumentList '/WS "http://localhost:8314" /C"RunUnitTests=yaxunit-config.json" /L ${{ steps.short_locale.outputs.substring }} /VL ${{ inputs.locale }} /DisableStartupDialogs /DisableStartupMessages /DisableUnrecoverableErrorMessage /Out 1cv8c-output.log'
        
        # Проверка результата выполнения
        Write-Host "Код завершения тестов: $($result.ExitCode)"
      timeout-minutes: 10

    - name: Сохранение файла отчета
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: Отчет о тестировании. ${{runner.os}} ${{ inputs.v8_version }} ${{ inputs.locale }}
        path: report.xml
        
    - name: Публикация отчета о тестировании
      uses: 1CDevFlow/action-onec-junit-report@main
      if: always()
      with:
        job_name: Тестирование
        check_name: Отчет о тестировании. ${{runner.os}} ${{ inputs.v8_version }} ${{ inputs.locale }}
        report_paths: report.xml
        fail_on_failure: true
        require_passed_tests: true
      
    - name: Лог выполнения
      if: always()
      continue-on-error: true
      run: cat log.txt

    - name: Лог платформы
      if: always()
      run: cat output.log
      continue-on-error: true

    - name: Очистка процессов (Linux)
      if: always() && runner.os == 'Linux'
      run: |
        echo "Очистка процессов ibsrv..."
        pkill -f ibsrv || echo "Процессы ibsrv не найдены"
        pkill -f xvfb || echo "Процессы xvfb не найдены"

    - name: Очистка процессов (Windows)
      if: always() && runner.os == 'Windows'
      shell: pwsh
      run: |
        Write-Host "Очистка процессов ibsrv..."
        try {
            Get-Process ibsrv -ErrorAction SilentlyContinue | Stop-Process -Force
            Write-Host "Процессы ibsrv остановлены"
        } catch {
            Write-Host "Ошибка остановки процессов ibsrv: $_"
        }
  