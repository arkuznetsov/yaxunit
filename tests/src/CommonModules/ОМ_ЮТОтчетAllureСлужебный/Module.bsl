//©///////////////////////////////////////////////////////////////////////////©//
//
//  Copyright 2021-2025 BIA-Technologies Limited Liability Company
//
//  Licensed under the Apache License, Version 2.0 (the "License");
//  you may not use this file except in compliance with the License.
//  You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
//  Unless required by applicable law or agreed to in writing, software
//  distributed under the License is distributed on an "AS IS" BASIS,
//  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
//  See the License for the specific language governing permissions and
//  limitations under the License.
//
//©///////////////////////////////////////////////////////////////////////////©//

#Область СлужебныйПрограммныйИнтерфейс

Процедура ИсполняемыеСценарии() Экспорт
	
	ЮТТесты
		.Настроить(ЮТАлюр
			.Epic("Unit tests")
			.Suite("Проверка формирования отчета Allure")
			.Feature("Проверка формирования отчета Allure")
			.Пакет("ФормированиеОтчета.Allure")
			.Owner("alkoleft")
			.Свойство("Проверяемый объект", "ЮТОтчетAllureСлужебный"))
		.ДобавитьТест("ПараметрыГенерацииОтчета")
		.ДобавитьТест("ЗаписатьОтчет")
		.ДобавитьТест("ОписаниеТеста")
		.ДобавитьТест("ОписаниеТеста_Представление")
		.ДобавитьТест("ОписаниеТеста_Теги")
		.ДобавитьТест("ОписаниеТеста_СвойстваAllure")
		.ДобавитьТест("ТестИсправленияAllureТегов")
	;
	
КонецПроцедуры

Процедура ПараметрыГенерацииОтчета() Экспорт
	
	ЮТАлюр.Описание("Проверка параметров генерации отчета Allure")
		.Серьезность(ЮТАлюр.УровниСерьезности().Критический);
	
	Параметры = ЮТОтчетAllureСлужебный.ПараметрыГенерацииОтчета();
	
	ЮТест.ОжидаетЧто(Параметры)
		.Свойство("Форматы")
			.ИмеетДлину(1)
			.ИмеетСвойство("allure");
	
КонецПроцедуры

Процедура ЗаписатьОтчет() Экспорт
	
	ЮТАлюр.Описание("Проверка записи отчета Allure в файл")
		.Серьезность(ЮТАлюр.УровниСерьезности().Критический);
	
	РезультатТестирования = ТестовыеДанные.РезультатТестирования();
	РезультатТестирования[0].Теги = ЮТКоллекции.ЗначениеВМассиве("Тестовый модуль");
	
	Каталог = ЮТест.Данные().НовоеИмяВременногоФайла();
	СоздатьКаталог(Каталог);
	Формат = ЮТОтчетAllureСлужебный.ПараметрыГенерацииОтчета().Форматы.allure;
	ЮТОтчетAllureСлужебный.ЗаписатьОтчет(РезультатТестирования, Каталог, Формат, Неопределено);
	
КонецПроцедуры

Процедура ОписаниеТеста() Экспорт
	
	ЮТАлюр.Описание("Проверка формирования описания теста в формате Allure")
		.Серьезность(ЮТАлюр.УровниСерьезности().Критический);
	
	Модуль = ТестовыеДанные.ОписаниеТестовогоМодуля();
	Набор = ТестовыеДанные.ОписаниеТестовогоНабора(Модуль);
	Тест = ТестовыеДанные.ОписаниеТеста(Модуль, Набор);
	
	ОписаниеТеста = ЮТОтчетAllureСлужебный.ОписаниеТеста(Тест, Набор, Модуль);
	ЮТест.ОжидаетЧто(ОписаниеТеста)
		.ИмеетТип("Структура")
		.Заполнено()
	;
	
	ИмяТестовогоНабора = Модуль.Метаданные.Имя;
	ИмяВложенногоНабора = СтрШаблон("%1 [%2]", Набор.Представление, Тест.Режим);
	СодержитМетку(ОписаниеТеста, "suite", ИмяТестовогоНабора);
	СодержитМетку(ОписаниеТеста, "subSuite", ИмяВложенногоНабора);
	
	Набор.Представление = Модуль.Метаданные.Имя;
	ОписаниеТеста = ЮТОтчетAllureСлужебный.ОписаниеТеста(Тест, Набор, Модуль);
	СодержитМетку(ОписаниеТеста, "suite", ИмяТестовогоНабора);
	ЮТест.ОжидаетЧто(ОписаниеТеста)
		.Свойство("labels")
		.НеСодержит(ЮТест.Предикат()
			.Реквизит("name").Равно("subSuite"))
	;
	
КонецПроцедуры

Процедура ОписаниеТеста_Представление() Экспорт
	
	ЮТАлюр.Описание("Проверка формирования представления теста")
		.Серьезность(ЮТАлюр.УровниСерьезности().Незначительный);
	
	Модуль = ТестовыеДанные.ОписаниеТестовогоМодуля();
	Набор = ТестовыеДанные.ОписаниеТестовогоНабора(Модуль);
	Тест = ТестовыеДанные.ОписаниеТеста(Модуль, Набор);
	Тест.Имя = "Нужное представление";
	
	ОписаниеТеста = ЮТОтчетAllureСлужебный.ОписаниеТеста(Тест, Набор, Модуль);
	ЮТест.ОжидаетЧто(ОписаниеТеста)
		.ИмеетТип("Структура")
		.Свойство("name").Равно(Тест.Имя)
		.Заполнено()
	;
	
КонецПроцедуры

Процедура ОписаниеТеста_Теги() Экспорт
	
	ЮТАлюр.Описание("Проверка установки тегов")
		.Серьезность(ЮТАлюр.УровниСерьезности().Незначительный);
	
	Модуль = ТестовыеДанные.ОписаниеТестовогоМодуля();
	Набор = ТестовыеДанные.ОписаниеТестовогоНабора(Модуль);
	Тест = ТестовыеДанные.ОписаниеТеста(Модуль, Набор);
	
	Модуль.Теги = ЮТСтроки.РазделитьСтроку("Модуль, Тег1, Тег 2", ",");
	Набор.Теги = ЮТСтроки.РазделитьСтроку("Набор, ТЕГ 2, Тег3", ",");
	Тест.Теги = СтрРазделить("Тест, тег3, тег4", ", ", Ложь);
	ОписаниеТеста = ЮТОтчетAllureСлужебный.ОписаниеТеста(Тест, Набор, Модуль);
	
	Для Каждого Метка Из ЮТСтроки.РазделитьСтроку("Модуль, Набор, Тест, Тег 2, Тег3, тег4", ",") Цикл
		СодержитМетку(ОписаниеТеста, "tag", Метка);
	КонецЦикла;
	
КонецПроцедуры

Процедура ОписаниеТеста_СвойстваAllure() Экспорт
	
	ЮТАлюр.Описание("Проверка заполнения установленных свойств Allure")
		.Серьезность(ЮТАлюр.УровниСерьезности().Незначительный);
	
	ПроизвольноеСвойство = "Произвольное свойство";
	ПроизвольноеСвойство2 = "Произвольное свойство";
	
	Модуль = ТестовыеДанные.ОписаниеТестовогоМодуля();
	Набор = ТестовыеДанные.ОписаниеТестовогоНабора(Модуль);
	Тест = ТестовыеДанные.ОписаниеТеста(Модуль, Набор);
	
	Модуль.СвойстваAllure.Вставить("epic", "Эпичный");
	Модуль.СвойстваAllure.Вставить("severity", "blocker");
	Набор.СвойстваAllure.Вставить("feature", "Функциональный");
	Тест.СвойстваAllure.Вставить("story", "История");
	Тест.СвойстваAllure.Вставить(ПроизвольноеСвойство, ПроизвольноеСвойство);
	Тест.СвойстваОтчета.Вставить(ПроизвольноеСвойство2, ПроизвольноеСвойство2);
	Тест.СвойстваAllure.Вставить("description", "Описание");
	
	ОписаниеТеста = ЮТОтчетAllureСлужебный.ОписаниеТеста(Тест, Набор, Модуль);
	
	ЮТест.ОжидаетЧто(ОписаниеТеста)
		.Свойство("description").Равно("Описание")
		.Свойство("labels")
			.Содержит(ЮТест.Предикат()
				.Реквизит("name").Равно("severity")
				.Реквизит("value").Равно("blocker"))
			.Содержит(ЮТест.Предикат()
				.Реквизит("name").Равно("epic")
				.Реквизит("value").Равно("Эпичный"))
			.Содержит(ЮТест.Предикат()
				.Реквизит("name").Равно("feature")
				.Реквизит("value").Равно("Функциональный"))
			.Содержит(ЮТест.Предикат()
				.Реквизит("name").Равно("story")
				.Реквизит("value").Равно("История"))
			.Содержит(ЮТест.Предикат()
				.Реквизит("name").Равно(ПроизвольноеСвойство)
				.Реквизит("value").Равно(ПроизвольноеСвойство))
			.Содержит(ЮТест.Предикат()
				.Реквизит("name").Равно(ПроизвольноеСвойство2)
				.Реквизит("value").Равно(ПроизвольноеСвойство2))
	;
КонецПроцедуры

#КонецОбласти

#Область Тесты

// Тест проверяет корректность формирования иерархии теста для Allure отчета
Процедура ТестИерархияТеста_БазовыеТеги() Экспорт
	
	// Подготовка
	РезультатТеста = Новый Структура("НомерВНаборе, Имя, Режим, ДатаСтарта, Длительность, Статус, Параметры, Ошибки");
	РезультатТеста.НомерВНаборе = 1;
	РезультатТеста.Имя = "ТестМетод";
	РезультатТеста.Режим = "Клиент";
	РезультатТеста.ДатаСтарта = ТекущаяДата();
	РезультатТеста.Длительность = 1000;
	РезультатТеста.Статус = "Успешно";
	РезультатТеста.Параметры = Новый Массив();
	РезультатТеста.Ошибки = Новый Массив();
	
	Набор = Новый Структура("Представление");
	Набор.Представление = "ТестовыйНабор";
	
	Модуль = Новый Структура("Метаданные, НаборыТестов");
	Модуль.Метаданные = Новый Структура("Имя");
	Модуль.Метаданные.Имя = "ТестовыйМодуль";
	Модуль.НаборыТестов = Новый Массив();
	Модуль.НаборыТестов.Добавить(Набор);
	
	СвойстваОтчета = Новый Соответствие();
	
	// Действие
	Иерархия = ЮТОтчетAllureСлужебный.ИерархияТеста(РезультатТеста, Набор, Модуль, СвойстваОтчета);
	
	// Проверка
	Ключи = ЮТФабрикаСлужебный.СвойстваAllure();
	
	ЮТест.ОжидаетЧто(Иерархия[Ключи.РодительскийНабор])
		.Равно("Unit tests", "parentSuite должен быть 'Unit tests' по умолчанию");
	
	ЮТест.ОжидаетЧто(Иерархия[Ключи.Набор])
		.Равно("ТестовыйМодуль", "suite должен быть именем модуля");
	
	ЮТест.ОжидаетЧто(Иерархия[Ключи.Эпик])
		.Равно("ТестовыйМодуль", "epic должен быть именем модуля по умолчанию");
	
КонецПроцедуры

// Тест проверяет, что настройки Allure на уровне модуля переопределяют глобальные
Процедура ТестИерархияТеста_ПереопределениеТегов() Экспорт
	
	// Подготовка
	РезультатТеста = Новый Структура("НомерВНаборе, Имя, Режим, ДатаСтарта, Длительность, Статус, Параметры, Ошибки");
	РезультатТеста.НомерВНаборе = 1;
	РезультатТеста.Имя = "ТестМетод";
	РезультатТеста.Режим = "Клиент";
	РезультатТеста.ДатаСтарта = ТекущаяДата();
	РезультатТеста.Длительность = 1000;
	РезультатТеста.Статус = "Успешно";
	РезультатТеста.Параметры = Новый Массив();
	РезультатТеста.Ошибки = Новый Массив();
	
	Набор = Новый Структура("Представление");
	Набор.Представление = "ТестовыйНабор";
	
	Модуль = Новый Структура("Метаданные, НаборыТестов");
	Модуль.Метаданные = Новый Структура("Имя");
	Модуль.Метаданные.Имя = "ТестовыйМодуль";
	Модуль.НаборыТестов = Новый Массив();
	Модуль.НаборыТестов.Добавить(Набор);
	
	// Настройка Allure тегов на уровне модуля
	СвойстваОтчета = Новый Соответствие();
	Ключи = ЮТФабрикаСлужебный.СвойстваAllure();
	СвойстваОтчета.Вставить(Ключи.РодительскийНабор, "Smoke tests");
	СвойстваОтчета.Вставить(Ключи.Эпик, "Smoke tests");
	СвойстваОтчета.Вставить(Ключи.Набор, "Дымовые тесты");
	
	// Действие
	Иерархия = ЮТОтчетAllureСлужебный.ИерархияТеста(РезультатТеста, Набор, Модуль, СвойстваОтчета);
	
	// Проверка - настройки модуля должны переопределить глобальные
	ЮТест.ОжидаетЧто(Иерархия[Ключи.РодительскийНабор])
		.Равно("Smoke tests", "parentSuite должен быть переопределен настройками модуля");
	
	ЮТест.ОжидаетЧто(Иерархия[Ключи.Эпик])
		.Равно("Smoke tests", "epic должен быть переопределен настройками модуля");
	
	ЮТест.ОжидаетЧто(Иерархия[Ключи.Набор])
		.Равно("Дымовые тесты", "suite должен быть переопределен настройками модуля");
	
КонецПроцедуры

// Тест проверяет корректность формирования имени модуля по схеме
Процедура ТестИмяМодуляПоСхеме_РазличныеФорматы() Экспорт
	
	// Подготовка и действие
	Описание1 = ЮТОтчетAllureСлужебный.ИмяМодуляПоСхеме("ОМ_ОбщийМодуль");
	Описание2 = ЮТОтчетAllureСлужебный.ИмяМодуляПоСхеме("Спр_Контрагенты_МО");
	Описание3 = ЮТОтчетAllureСлужебный.ИмяМодуляПоСхеме("ПростоеИмя");
	
	// Проверка
	ЮТест.ОжидаетЧто(Описание1.epic)
		.Равно("Общий модуль", "epic для ОМ_ должен быть 'Общий модуль'");
	
	ЮТест.ОжидаетЧто(Описание1.feature)
		.Равно("ОбщийМодуль", "feature должен быть второй частью имени");
	
	ЮТест.ОжидаетЧто(Описание2.epic)
		.Равно("Справочник", "epic для Спр_ должен быть 'Справочник'");
	
	ЮТест.ОжидаетЧто(Описание2.feature)
		.Равно("Контрагенты", "feature должен быть второй частью имени");
	
	ЮТест.ОжидаетЧто(Описание2.story)
		.Равно("Модуль объекта", "story для _МО должен быть 'Модуль объекта'");
	
	ЮТест.ОжидаетЧто(Описание3.epic)
		.Равно("ПростоеИмя", "epic для простого имени должен быть самим именем");
	
КонецПроцедуры

// Тест проверяет корректность формирования описания теста
Процедура ТестОписаниеТеста_БазовыеСвойства() Экспорт
	
	// Подготовка
	РезультатТеста = Новый Структура("НомерВНаборе, Имя, Режим, ДатаСтарта, Длительность, Статус, Параметры, Ошибки");
	РезультатТеста.НомерВНаборе = 1;
	РезультатТеста.Имя = "ТестМетод";
	РезультатТеста.Режим = "Клиент";
	РезультатТеста.ДатаСтарта = ТекущаяДата();
	РезультатТеста.Длительность = 1000;
	
	РезультатТеста.Статус = "Успешно";
	РезультатТеста.Параметры = Новый Массив();
	РезультатТеста.Ошибки = Новый Массив();
	
	Набор = Новый Структура("Представление");
	Набор.Представление = "ТестовыйНабор";
	
	Модуль = Новый Структура("Метаданные, НаборыТестов");
	Модуль.Метаданные = Новый Структура("Имя");
	Модуль.Метаданные.Имя = "ТестовыйМодуль";
	Модуль.НаборыТестов = Новый Массив();
	Модуль.НаборыТестов.Добавить(Набор);
	
	// Действие
	Описание = ЮТОтчетAllureСлужебный.ОписаниеТеста(РезультатТеста, Набор, Модуль);
	
	// Проверка базовых свойств
	ЮТест.ОжидаетЧто(Описание.name)
		.Равно("ТестМетод", "name должен быть именем теста");
	
	ЮТест.ОжидаетЧто(Описание.status)
		.Равно("passed", "status должен быть 'passed' для успешного теста");
	
	ЮТест.ОжидаетЧто(Описание.fullName)
		.Содержит("ТестовыйМодуль.ТестМетод", "fullName должен содержать имя модуля и метода");
	
	ЮТест.ОжидаетЧто(Описание.fullName)
		.Содержит("[Клиент]", "fullName должен содержать режим теста");
	
КонецПроцедуры

// Простой тест для проверки исправления Allure тегов
Процедура ТестИсправленияAllureТегов() Экспорт
	
	ЮТАлюр.Описание("Проверка исправления Allure тегов для smoke тестов")
		.Серьезность(ЮТАлюр.УровниСерьезности().Критический);
	
	// Подготовка тестовых данных
	РезультатТеста = Новый Структура("НомерВНаборе, Имя, Режим, ДатаСтарта, Длительность, Статус, Параметры, Ошибки");
	РезультатТеста.НомерВНаборе = 1;
	РезультатТеста.Имя = "ТестМетод";
	РезультатТеста.Режим = "Клиент";
	РезультатТеста.ДатаСтарта = ТекущаяДата();
	РезультатТеста.Длительность = 1000;
	РезультатТеста.Статус = "Успешно";
	РезультатТеста.Параметры = Новый Массив();
	РезультатТеста.Ошибки = Новый Массив();
	
	Набор = Новый Структура("Представление");
	Набор.Представление = "ТестовыйНабор";
	
	Модуль = Новый Структура("Метаданные, НаборыТестов");
	Модуль.Метаданные = Новый Структура("Имя");
	Модуль.Метаданные.Имя = "ТестовыйМодуль";
	Модуль.НаборыТестов = Новый Массив();
	Модуль.НаборыТестов.Добавить(Набор);
	
	// Тест 1: Проверка базового поведения (parentSuite = "Unit tests")
	СвойстваОтчета = Новый Соответствие();
	Иерархия = ЮТОтчетAllureСлужебный.ИерархияТеста(РезультатТеста, Набор, Модуль, СвойстваОтчета);
	
	Ключи = ЮТФабрикаСлужебный.СвойстваAllure();
	
	ЮТест.ОжидаетЧто(Иерархия[Ключи.РодительскийНабор])
		.Равно("Unit tests", "parentSuite должен быть 'Unit tests' по умолчанию");
	
	// Тест 2: Проверка переопределения через настройки
	СвойстваОтчета.Вставить(Ключи.РодительскийНабор, "Smoke tests");
	СвойстваОтчета.Вставить(Ключи.Эпик, "Smoke tests");
	СвойстваОтчета.Вставить(Ключи.Набор, "Дымовые тесты");
	
	Иерархия = ЮТОтчетAllureСлужебный.ИерархияТеста(РезультатТеста, Набор, Модуль, СвойстваОтчета);
	
	ЮТест.ОжидаетЧто(Иерархия[Ключи.РодительскийНабор])
		.Равно("Smoke tests", "parentSuite должен быть переопределен настройками модуля");
	
	ЮТест.ОжидаетЧто(Иерархия[Ключи.Эпик])
		.Равно("Smoke tests", "epic должен быть переопределен настройками модуля");
	
	ЮТест.ОжидаетЧто(Иерархия[Ключи.Набор])
		.Равно("Дымовые тесты", "suite должен быть переопределен настройками модуля");
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура СодержитМетку(ОписаниеТеста, ИмяМетки, ЗначениеМетки)
	
	ЮТест.ОжидаетЧто(ОписаниеТеста)
		.Свойство("labels")
		.Содержит(ЮТест.Предикат()
			.Реквизит("name").Равно(ИмяМетки)
			.Реквизит("value").Равно(ЗначениеМетки))
	;
КонецПроцедуры

#КонецОбласти
